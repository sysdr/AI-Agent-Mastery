<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Learning & Compliance Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-title {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }
        .metric-subtitle {
            color: #999;
            font-size: 14px;
        }
        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.healthy {
            background-color: #4CAF50;
        }
        .status-indicator.unhealthy {
            background-color: #f44336;
        }
        .test-controls {
            margin-bottom: 20px;
        }
        .test-controls input, .test-controls button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-controls button {
            background-color: #2196F3;
            color: white;
            cursor: pointer;
        }
        .test-controls button:hover {
            background-color: #1976D2;
        }
        .recommendation-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .recommendation-score {
            font-weight: bold;
            color: #4CAF50;
        }
        .recommendation-explanation {
            font-style: italic;
            color: #666;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            color: #f44336;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Agent Learning & Compliance Dashboard</h1>
            <p>Real-time monitoring of privacy-preserving AI agent learning system</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">System Health</div>
                <div class="metric-value" id="health-status">Checking...</div>
                <div class="metric-subtitle">Backend Services</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Bias Detection Alerts</div>
                <div class="metric-value" id="bias-alerts">0</div>
                <div class="metric-subtitle">Last 24 hours</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Active A/B Tests</div>
                <div class="metric-value" id="ab-tests">0</div>
                <div class="metric-subtitle">Currently running</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Recommendation Quality</div>
                <div class="metric-value" id="rec-quality">0.00</div>
                <div class="metric-subtitle">Average confidence</div>
            </div>
        </div>

        <div class="section">
            <h3>System Status</h3>
            <div id="system-status">
                <div><span class="status-indicator" id="pref-status"></span>Preference Learning Service</div>
                <div><span class="status-indicator" id="bias-status"></span>Bias Detection Engine</div>
                <div><span class="status-indicator" id="ab-status"></span>A/B Testing Framework</div>
                <div><span class="status-indicator" id="rec-status"></span>Recommendation Engine</div>
            </div>
        </div>

        <div class="section">
            <h3>Test Recommendations</h3>
            <div class="test-controls">
                <input type="text" id="user-id" placeholder="User ID" value="test_user_001">
                <button onclick="getRecommendations()">Get Recommendations</button>
                <button onclick="recordInteraction('view')">Record View</button>
                <button onclick="recordInteraction('like')">Record Like</button>
            </div>
            <div id="recommendations-container"></div>
        </div>

        <div class="section">
            <h3>Bias Report</h3>
            <div id="bias-report-container">
                <div class="loading">Loading bias report...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        // Update metrics every 10 seconds
        setInterval(updateMetrics, 10000);
        setInterval(updateBiasReport, 30000);
        
        // Initial load
        updateMetrics();
        updateBiasReport();
        
        async function updateMetrics() {
            try {
                const response = await fetch(`${API_BASE_URL}/metrics`);
                const data = await response.json();
                
                document.getElementById('bias-alerts').textContent = data.bias_detection_alerts || 0;
                document.getElementById('ab-tests').textContent = data.active_ab_tests || 0;
                
                // Update recommendation quality (simulate for demo)
                const quality = (Math.random() * 0.3 + 0.7).toFixed(2);
                document.getElementById('rec-quality').textContent = quality;
                
            } catch (error) {
                console.error('Failed to fetch metrics:', error);
            }
        }
        
        async function updateHealthStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                const healthStatus = data.status === 'healthy' ? 'Healthy' : 'Unhealthy';
                document.getElementById('health-status').textContent = healthStatus;
                
                // Update service status indicators
                const services = data.services || {};
                document.getElementById('pref-status').className = `status-indicator ${services.preference_learning ? 'healthy' : 'unhealthy'}`;
                document.getElementById('bias-status').className = `status-indicator ${services.bias_detection ? 'healthy' : 'unhealthy'}`;
                document.getElementById('ab-status').className = `status-indicator ${services.ab_testing ? 'healthy' : 'unhealthy'}`;
                document.getElementById('rec-status').className = `status-indicator ${services.recommendation ? 'healthy' : 'unhealthy'}`;
                
            } catch (error) {
                console.error('Failed to fetch health status:', error);
                document.getElementById('health-status').textContent = 'Unhealthy';
            }
        }
        
        async function updateBiasReport() {
            try {
                const response = await fetch(`${API_BASE_URL}/bias-report`);
                const data = await response.json();
                
                const container = document.getElementById('bias-report-container');
                container.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-title">Overall Bias Score</div>
                        <div class="metric-value">${data.overall_bias_score.toFixed(3)}</div>
                        <div class="metric-subtitle">${data.has_significant_bias ? '⚠️ Significant bias detected' : '✅ No significant bias'}</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>Affected Users:</strong> ${data.affected_user_count}<br>
                        <strong>Recommendations:</strong> ${data.recommendations.length > 0 ? data.recommendations.join(', ') : 'None'}
                    </div>
                `;
                
            } catch (error) {
                console.error('Failed to fetch bias report:', error);
                document.getElementById('bias-report-container').innerHTML = '<div class="error">Failed to load bias report</div>';
            }
        }
        
        async function getRecommendations() {
            const userId = document.getElementById('user-id').value;
            const container = document.getElementById('recommendations-container');
            
            container.innerHTML = '<div class="loading">Loading recommendations...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/recommendations/${userId}?count=5`);
                const data = await response.json();
                
                let html = `
                    <h4>Recommendations for ${data.user_id}</h4>
                    <p><strong>Generated:</strong> ${new Date(data.generated_at).toLocaleString()}</p>
                    <p><strong>Algorithm:</strong> ${data.algorithm_version}</p>
                `;
                
                data.recommendations.forEach((rec, index) => {
                    html += `
                        <div class="recommendation-item">
                            <div><strong>${rec.item_id}</strong> <span class="recommendation-score">Score: ${rec.score.toFixed(2)}</span></div>
                            <div class="recommendation-explanation">${rec.explanation}</div>
                            <div style="margin-top: 10px;">
                                <button onclick="recordInteraction('view', '${rec.item_id}')">👁️ View</button>
                                <button onclick="recordInteraction('like', '${rec.item_id}')">👍 Like</button>
                                <button onclick="recordInteraction('click', '${rec.item_id}')">🖱️ Click</button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Failed to fetch recommendations:', error);
                container.innerHTML = '<div class="error">Failed to load recommendations</div>';
            }
        }
        
        async function recordInteraction(type, itemId = 'test_item_123') {
            const userId = document.getElementById('user-id').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        item_id: itemId,
                        interaction_type: type,
                        context: { test_mode: true }
                    })
                });
                
                if (response.ok) {
                    alert(`Recorded ${type} interaction for ${itemId}`);
                    // Refresh metrics after recording interaction
                    updateMetrics();
                } else {
                    alert(`Failed to record interaction: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Failed to record interaction:', error);
                alert('Failed to record interaction');
            }
        }
        
        // Initial health check
        updateHealthStatus();
    </script>
</body>
</html>
